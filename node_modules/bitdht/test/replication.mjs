import test from 'brittle'

import { withMatrix } from './helpers/with-matrix.mjs'
import { withScroll } from './helpers/with-scroll.mjs'
import { withDHT } from './helpers/with-dht.mjs'
import { withRelay } from './helpers/ws/with-relay.mjs'

test('scroll replication', (t) =>
  withDHT((a) => withRelay(a, (withDHT) => withMatrix({ custodial: [true, false] }, (options) => withDHT(options, (b) => withScroll((remote) => withScroll(remote.key, async (local) => {
    t.comment(`custodial = ${options.custodial}`)

    const replication = t.test('replication')
    replication.plan(1)

    const server = b.createServer()
    await server.listen()

    server.once('connection', async (socket) => {
      remote.replicate(socket)

      await remote.append(['hello', 'world'])
      await replication

      socket.end()
    })

    const socket = b.connect(server.publicKey)

    socket.once('open', async () => {
      local.replicate(socket)

      replication.alike(
        [
          await local.get(0),
          await local.get(1)
        ],
        [
          Buffer.from('hello'),
          Buffer.from('world')
        ]
      )
    })

    await replication.then(() => server.close())
  }))))))
)
